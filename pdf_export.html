<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Export - Matalan</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #525659;
            display: flex;
            justify-content: center;
            font-family: 'Inter', sans-serif;
        }

        #page {
            width: 210mm;
            min-height: 297mm;
            background: white;
            padding: 10mm;
            box-sizing: border-box;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            margin: 20px;
            position: relative;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 2px solid #00205b;
            padding-bottom: 0.75rem;
            padding-left: 1rem;
            padding-right: 1rem;
        }

        .logo {
            height: 35px;
            width: auto;
            object-fit: contain;
        }

        .header-title {
            color: #e31837;
            /* Matalan Red-ish */
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .content {
            margin-top: 1rem;
        }

        h2 {
            font-size: 1.1rem;
            color: #e31837;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        .grid-row {
            display: flex;
            gap: 2rem;
            margin-bottom: 0.5rem;
        }

        .grid-item {
            flex: 1;
        }

        /* Dimensions row */
        .dims-row {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            background: #f8fafc;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .dim-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .label {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }

        .value {
            font-size: 1rem;
            color: #0f172a;
            font-weight: 700;
        }

        .cost-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .cost-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            border-bottom: 1px dotted #ccc;
        }

        .cost-row.highlight {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 6px;
            font-weight: bold;
            color: #00205b;
        }

        @media print {

            #status-bar,
            #download-btn {
                display: none !important;
            }

            @page {
                size: A4 portrait;
                margin: 0;
            }

            body {
                background: white;
                margin: 0;
                padding: 0;
                display: block;
            }

            #page {
                width: 100%;
                min-height: auto;
                margin: 0;
                padding: 10mm;
                box-shadow: none;
                border: none;
            }
        }
    </style>
</head>

<body>

    <div id="status-bar"
        style="position: fixed; top: 0; left: 0; width: 100%; background: #00205b; color: white; padding: 10px; text-align: center; font-size: 14px; z-index: 1000;">
        Generating PDF... Please wait.
    </div>

    <div id="page">
        <div class="header">
            <img src="pacd.png" alt="PACD" class="logo">
            <img src="matalan.png" alt="Matalan" class="logo" style="height: 35px;">
        </div>

        <h1 style="text-align: center; color: #00205b; font-size: 1.5rem; margin-top: -10px; margin-bottom: 5px;">Carton
            Price Calculator</h1>

        <div style="text-align: right; margin-bottom: 20px; font-size: 0.85rem; color: #64748b;">
            Date: <span id="date-header"></span>
        </div>

        <div class="content">
            <h2>Supplier & Factory Information</h2>
            <div id="supplier-container"></div>

            <div id="specs-container"></div>

            <h2>Outside Dimension (mm) - FEFCO 0201</h2>
            <div class="dims-row" id="dims-container"></div>

            <div class="dims-row" id="area-container" style="margin-top: 1rem; grid-template-columns: 1fr 1fr;"></div>

            <h2 id="cost-header">Cost Breakdown</h2>
            <div class="cost-list" id="costs-container"></div>
        </div>
    </div>


    <button id="download-btn" onclick="generatePDF()"
        style="display: none; position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; background: #e31837; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
        Download PDF Again
    </button>

    <script>
        function getExportData() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const encodedData = urlParams.get('data');
                if (encodedData) {
                    return JSON.parse(decodeURIComponent(atob(encodedData)));
                }
                return JSON.parse(window.localStorage.getItem('matalanPrintData'));
            } catch (e) {
                console.error('Error retrieving data:', e);
                return null;
            }
        }

        function generatePDF() {
            const element = document.getElementById('page');
            const status = document.getElementById('status-bar');

            status.textContent = 'Generating PDF...';

            let filename = 'Matalan-Carton-Price.pdf';
            try {
                const data = getExportData();
                if (data && data.dims) {
                    const isStandard = data.specs.cartonStyle && data.specs.cartonStyle.includes('Standard');
                    const prefix = isStandard ? 'stn' : 'cus';
                    const L = data.dims.length;
                    const W = data.dims.width;
                    const H = data.dims.height;
                    filename = `Matalan_${prefix}${L}x${W}x${H}.pdf`;
                }
            } catch (e) { }

            const clone = element.cloneNode(true);
            clone.style.transform = 'none';
            clone.style.margin = '0';
            clone.style.padding = '10mm';
            clone.style.boxShadow = 'none';
            clone.style.border = 'none';
            clone.style.width = '210mm';
            clone.style.minHeight = '297mm';
            clone.style.background = '#ffffff';

            const container = document.createElement('div');
            container.style.position = 'fixed';
            container.style.top = '0';
            container.style.left = '0';
            container.style.width = '210mm';
            container.style.height = '297mm';
            container.style.overflow = 'hidden';
            container.style.zIndex = '-9999';
            container.style.background = '#ffffff';
            container.appendChild(clone);
            document.body.appendChild(container);

            const opt = {
                margin: 0,
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: {
                    scale: 2,
                    useCORS: true,
                    scrollY: 0,
                    width: 794,
                    height: 1123,
                    windowWidth: 794,
                    windowHeight: 1123
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(clone).toPdf().get('pdf').then(function (pdf) {
                const totalPages = pdf.internal.getNumberOfPages();
                if (totalPages > 1) {
                    for (let i = totalPages; i > 1; i--) {
                        pdf.deletePage(i);
                    }
                }
            }).save().then(() => {
                if (document.body.contains(container)) document.body.removeChild(container);
                status.textContent = 'PDF Downloaded!';
                status.style.background = '#10b981';
                document.getElementById('download-btn').style.display = 'block';
            }).catch(err => {
                console.error(err);
                if (document.body.contains(container)) document.body.removeChild(container);
                status.textContent = 'Error generating PDF.';
                status.style.background = '#e31837';
                document.getElementById('download-btn').style.display = 'block';
            });
        }

        window.onload = function () {
            const data = getExportData();
            if (!data) {
                document.body.innerHTML = '<h1 style="color: white; margin-top: 50px;">No data found.</h1>';
                return;
            }


            document.getElementById('date-header').textContent = new Date().toLocaleDateString();

            // Supplier Information
            if (data.supplier) {
                const supplierDiv = document.getElementById('supplier-container');
                let supplierHtml = '';

                // Row 1: Origin
                if (data.supplier.origin) {
                    supplierHtml += `
                        <div style="display: flex; gap: 1rem; margin-bottom: 0.75rem;">
                            <div style="flex: 1;">
                                <div class="label">Origin</div>
                                <div class="value">${data.supplier.origin}</div>
                            </div>
                        </div>
                    `;
                }

                // Row 2: Supplier
                supplierHtml += `
                    <div style="display: flex; gap: 1rem; margin-bottom: 0.75rem;">
                        <div style="flex: 3;">
                            <div class="label">Supplier Name</div>
                            <div class="value" style="white-space: normal; word-wrap: break-word;">${data.supplier.supplierName || '-'}</div>
                        </div>
                        <div style="flex: 1;">
                            <div class="label">Supplier Code</div>
                            <div class="value">${data.supplier.supplierCode || '-'}</div>
                        </div>
                    </div>
                `;

                // Row 3: Factory
                supplierHtml += `
                    <div style="display: flex; gap: 1rem; margin-bottom: 0.75rem;">
                        <div style="flex: 3;">
                            <div class="label">Factory Name</div>
                            <div class="value" style="white-space: normal; word-wrap: break-word;">${data.supplier.factoryName || '-'}</div>
                        </div>
                        <div style="flex: 1;">
                            <div class="label">Factory Code</div>
                            <div class="value">${data.supplier.factoryCode || '-'}</div>
                        </div>
                    </div>
                `;

                // Row 4: Packaging Supplier
                if (data.supplier.packagingSupplier) {
                    supplierHtml += `
                        <div style="display: flex; gap: 1rem; margin-bottom: 0.75rem;">
                            <div style="flex: 1;">
                                <div class="label">Packaging Supplier</div>
                                <div class="value">${data.supplier.packagingSupplier}</div>
                            </div>
                        </div>
                    `;
                }

                supplierDiv.innerHTML = supplierHtml;
            }

            // Specs
            const specsDiv = document.getElementById('specs-container');
            let specsHtml = '<h2>Specifications</h2><div class="grid-row">';

            if (data.specs.packType) {
                specsHtml += `<div class="grid-item"><div class="label">Pack Type</div><div class="value">${data.specs.packType}</div></div>`;
                specsHtml += `<div class="grid-item"><div class="label">Pack & Path Code</div><div class="value">${data.specs.packPath || '-'}</div></div></div><div class="grid-row">`;
            }

            specsHtml += `<div class="grid-item"><div class="label">Flute Type</div><div class="value">${data.specs.flute}</div></div>`;
            specsHtml += `<div class="grid-item"><div class="label">Carton Type</div><div class="value">${data.specs.cartonStyle}</div></div>`;
            specsHtml += `</div><div class="grid-row" style="margin-top: 1rem;">`;

            if (data.specs.cartonSelection) {
                specsHtml += `<div class="grid-item"><div class="label">Carton Selection</div><div class="value">${data.specs.cartonSelection}</div></div>`;
            }
            specsHtml += `<div class="grid-item"><div class="label">Quantity</div><div class="value">${data.dims.quantity}</div></div>`;
            specsHtml += `</div>`;

            specsDiv.innerHTML = specsHtml;

            // Dims
            document.getElementById('dims-container').innerHTML = `
                <div class="dim-box"><div class="label">Length</div><div class="value">${data.dims.length} mm</div></div>
                <div class="dim-box"><div class="label">Width</div><div class="value">${data.dims.width} mm</div></div>
                <div class="dim-box"><div class="label">Height</div><div class="value">${data.dims.height} mm</div></div>
            `;

            document.getElementById('area-container').innerHTML = `
                <div class="dim-box"><div class="label">Blank Sheet Length</div><div class="value">${data.dims.sheetLength || '-'}</div></div>
                <div class="dim-box"><div class="label">Blank Sheet Width</div><div class="value">${data.dims.sheetWidth || '-'}</div></div>
                <div class="dim-box"><div class="label">Area / Carton</div><div class="value">${data.dims.areaPerCarton || '-'}</div></div>
                <div class="dim-box"><div class="label">Total Area</div><div class="value">${data.dims.totalArea || '-'}</div></div>
            `;

            // Costs
            const costsDiv = document.getElementById('costs-container');
            if (!data.costs || data.costs.length === 0) {
                document.getElementById('cost-header').style.display = 'none';
            } else {
                let costsHtml = '';
                data.costs.forEach(item => {
                    const cls = item.highlight ? 'cost-row highlight' : 'cost-row';
                    costsHtml += `<div class="${cls}"><span>${item.label}</span><span>${item.value}</span></div>`;
                });
                costsDiv.innerHTML = costsHtml;
            }

            setTimeout(generatePDF, 800);
        };
    </script>
</body>

</html>